<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DSR Superadmin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css" />
  </head>
  <body>
    <script src="https://unpkg.com/vue@3"></script>

    <main id="root">
      <div class="container mt-6">
        <section class="panel">
          <p class="panel-heading is-flex is-align-items-center is-justify-content-space-between">
            <span>Demand Side Response - Superadmin</span>
            <button class="button is-primary" @click="openCreateModal">Create new aggregator</button>
          </p>
          <p class="panel-tabs">
            <a :class="{ 'is-active': activeTab === 0 }" @click="activeTab = 0">Aggregators</a>
            <a :class="{ 'is-active': activeTab === 1 }" @click="activeTab = 1">Devices</a>
          </p>
          <div v-if="activeTab === 1" class="panel-block">
            <p class="control has-icons-left">
              <input class="input" type="text" placeholder="Search" />
              <span class="icon is-left">
                <i class="fas fa-search" aria-hidden="true"></i>
              </span>
            </p>
          </div>
          <div v-if="listRequestStatus === 'pending'" class="panel-block">
            <progress class="progress is-small is-primary" max="100">15%</progress>
          </div>
          <div
            v-if="activeTab === 0"
            v-for="(item, index) in items"
            class="panel-block is-justify-content-space-between"
          >
            <p>
              <span class="title is-5">{{ index + 1 }}. {{ item.clientName }}</span>
              <span> (ID: {{ item.clientId }})</span>
            </p>
            <form @submit.prevent="openRemoveModal">
              <input type="hidden" name="clientId" :value="item.clientId" />
              <input type="hidden" name="clientName" :value="item.clientName" />
              <button class="button delete has-background-danger"></button>
            </form>
          </div>
        </section>
      </div>
      <!-- Create modal -->
      <div class="modal" :class="{ 'is-active': isCreating }">
        <div class="modal-background"></div>
        <form class="modal-card" @submit.prevent="createAppClient">
          <header class="modal-card-head">
            <p class="modal-card-title">New Aggregator</p>
            <button class="delete" @click="closeCreateModal"></button>
          </header>
          <section class="modal-card-body">
            <div class="field">
              <label class="label">Name</label>
              <div class="control">
                <input required class="input" name="clientName" />
              </div>
            </div>
          </section>
          <footer class="modal-card-foot">
            <button class="button is-success">Create</button>
            <button type="button" class="button" @click="closeCreateModal">Cancel</button>
            <span v-if="createRequestStatus === 'pending'">loading...</span>
          </footer>
        </form>
      </div>
      <!-- Remove modal -->
      <div v-if="clientForRemove !== null" class="modal is-active">
        <div class="modal-background"></div>
        <form class="modal-card" @submit.prevent="removeAppClient">
          <header class="modal-card-head">
            <p class="modal-card-title">Delete aggregator "{{ clientForRemove.clientName }}"?</p>
            <button class="delete" @click="closeRemoveModal"></button>
          </header>
          <section class="modal-card-body">
            <input type="hidden" class="input" name="clientId" :value="clientForRemove.clientId" />
            <div class="field">
              <label class="label"
                >To confirm deletion, enter <i>{{clientForRemove.clientName}}</i> in the field.</label
              >
              <div class="control">
                <input
                  required
                  class="input"
                  name="clientName"
                  :placeholder="clientForRemove.clientName"
                  :class="{ 'is-danger': isError }"
                />
              </div>
              <p v-if="isError" class="help is-danger">Wrong value</p>
            </div>
          </section>
          <footer class="modal-card-foot">
            <button class="button is-danger" :disabled="removeRequestStatus === 'pending'">Delete</button>
            <button type="button" class="button" @click="closeRemoveModal">Cancel</button>
            <span v-if="removeRequestStatus === 'pending'">loading...</span>
          </footer>
        </form>
      </div>
      <!-- Client Secret modal-->
      <div v-if="client !== null" class="modal is-active">
        <div class="modal-background"></div>
        <div class="modal-card">
          <header class="modal-card-head">
            <p class="modal-card-title">{{ client.clientName }}</p>
            <button class="delete" aria-label="close" @click="closeModal"></button>
          </header>
          <section class="modal-card-body">
            <div class="content">
              <h4>Secret key</h4>
              <blockquote class="is-flex is-align-items-center is-justify-content-space-between">
                <span>{{ client.clientSecret }}</span>
                <button class="button is-small">Copy</button>
              </blockquote>
              <article class="message is-warning">
                <div class="message-header">
                  <p>Warning</p>
                </div>
                <div class="message-body">Make sure to copy this token, you wonâ€™t be able to see it again!</div>
              </article>
            </div>
          </section>
        </div>
      </div>
    </main>

    <script>
      Vue.createApp({
        data() {
          return {
            activeTab: 0,
            isError: false,
            isCreating: false,
            listRequestStatus: 'idle',
            createRequestStatus: 'idle',
            removeRequestStatus: 'idle',
            items: [],
            client: null,
            clientForRemove: null,
          };
        },
        methods: {
          openCreateModal() {
            this.isCreating = true;
          },
          closeCreateModal() {
            this.isCreating = false;
          },
          openRemoveModal(event) {
            const clientId = event.target.elements.clientId.value;
            const clientName = event.target.elements.clientName.value;
            this.clientForRemove = {
              clientId,
              clientName,
            };
          },
          closeRemoveModal() {
            this.clientForRemove = null;
          },
          closeModal() {
            this.client = null;
            this.listAppClients();
          },
          copySecret() {
            if (!this.client) {
              return;
            }
            navigator.clipboard.writeText(this.client.clientSecret);
          },
          createAppClient(event) {
            const clientName = event.target.elements.clientName.value;
            this.createRequestStatus = 'pending';
            fetch('/admin-api/create-app-client', {
              method: 'POST',
              body: JSON.stringify({ name: clientName }),
              headers: {
                'Content-Type': 'application/json',
              },
            })
              .then((resp) => {
                if (!resp.ok) {
                  throw new Error();
                }
                return resp.json();
              })
              .then((data) => {
                this.createRequestStatus = 'idle';
                this.isCreating = false;
                this.client = data;
              })
              .catch((error) => {
                console.error(error);
                this.createRequestStatus = 'error';
              });
          },
          removeAppClient(event) {
            const clientId = event.target.elements.clientId.value;
            const clientName = event.target.elements.clientName.value;
            if (clientName !== this.clientForRemove.clientName) {
              this.isError = true;
              return;
            }
            this.removeRequestStatus = 'pending';
            fetch('/admin-api/remove-app-client', {
              method: 'POST',
              body: JSON.stringify({ id: clientId }),
              headers: {
                'Content-Type': 'application/json',
              },
            })
              .then((resp) => {
                if (!resp.ok) {
                  throw new Error();
                }
                return resp.json();
              })
              .then((data) => {
                this.removeRequestStatus = 'idle';
                this.clientForRemove = null;
                return this.listAppClients();
              })
              .catch((error) => {
                console.error(error);
                this.removeRequestStatus = 'error';
              });
          },
          listAppClients() {
            this.items = [];
            this.listRequestStatus = 'pending';
            fetch('/admin-api/app-clients')
              .then((resp) => resp.json())
              .then((data) => {
                this.items = data;
                this.listRequestStatus = 'idle';
              })
              .catch((error) => {
                console.error(error);
                this.listRequestStatus = 'error';
              });
          },
        },
        mounted() {
          this.listAppClients();
        },
      }).mount('#root');
    </script>
  </body>
</html>
